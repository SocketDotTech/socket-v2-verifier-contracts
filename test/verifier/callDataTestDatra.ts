import cloneDeep from "lodash.clonedeep";
import merge from "lodash.merge";

import { SocketV2Verifier } from "../../src/types";
import { SOCKET_REGISTRY_ADDRESS } from "./SocketV2Verifier.fixture";

const NATIVE_TOKEN_ADDRESS = "0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee";
const NOT_SOCKET_REGISTRY = "0x00000000006c3852cbef3e08e8df289169ede581";

interface TestData {
  description: string;
  target: string;
  data: string;
  expected: SocketV2Verifier.ExpectedRequestStruct;
}

interface InvalidTestData extends TestData {
  error: string;
}

const UNSPECIFIED_MIDDLEWARE = {
  id: 0,
  optionalNativeAmount: 0,
  inputToken: NATIVE_TOKEN_ADDRESS,
  data: "0x",
};

const validCallDataTests: TestData[] = [
  {
    description: "bridge native token",
    target: SOCKET_REGISTRY_ADDRESS,
    data: "0xa44bbb150000000000000000000000000000000000000000000000000000000000000020000000000000000000000000b7d8c49945144ec82605ed877a5e0dc4bfbb7f63000000000000000000000000000000000000000000000000000000000000a4b100000000000000000000000000000000000000000000000017979cfe362a000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000b8901acb165ed027e32754e0ffe830802919727f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001778cc610af9d4ee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000182f8daf77d0000000000000000000000000000000000000000000000000000000000000001",
    expected: {
      target: SOCKET_REGISTRY_ADDRESS,
      receiverAddress: "0xb7d8c49945144ec82605ed877a5e0dc4bfbb7f63",
      toChainId: 42161,
      amount: "1700000000000000000",
      bridgeRequest: {
        id: 18,
        optionalNativeAmount: 0,
        inputToken: NATIVE_TOKEN_ADDRESS,
      },
      middlewareRequest: UNSPECIFIED_MIDDLEWARE,
    },
  },
  {
    description: "erc20 bridge",
    target: SOCKET_REGISTRY_ADDRESS,
    data: "0xa44bbb1500000000000000000000000000000000000000000000000000000000000000200000000000000000000000005b3a9a05fec4434c6182246576a425c4472a3ec000000000000000000000000000000000000000000000000000000000000000890000000000000000000000000000000000000000000000000000000005be21ca00000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000",
    expected: {
      target: SOCKET_REGISTRY_ADDRESS,
      receiverAddress: "0x5B3a9A05fEC4434c6182246576a425c4472a3EC0",
      toChainId: 137,
      amount: "96346570",
      bridgeRequest: {
        id: 2,
        optionalNativeAmount: 0,
        inputToken: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
      },
      middlewareRequest: UNSPECIFIED_MIDDLEWARE,
    },
  },
  {
    description: "weth with middleware",
    target: SOCKET_REGISTRY_ADDRESS,
    data: "0xa44bbb150000000000000000000000000000000000000000000000000000000000000020000000000000000000000000b814e113a905ae84777bf3f80e4d07a9635b78dd000000000000000000000000000000000000000000000000000000000000a4b100000000000000000000000000000000000000000000000000b9ce92a9c0c00000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000003a87c025200000000000000000000000000f2f400c138f9fb900576263af0bc7fcde2b1b8a800000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000f2f400c138f9fb900576263af0bc7fcde2b1b8a8000000000000000000000000c30141b657f4216252dc59af2e7cdb9d8792e1b000000000000000000000000000000000000000000000000000b9ce92a9c0c00000000000000000000000000000000000000000000000000000b8e0bd7324e800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000e0800000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000b9ce92a9c0c00000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000004d0e30db000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb0000000000000000000000001111111254fb6c44bac0bed2854e76f90643097d00000000000000000000000000000000000000000000000000b9ce92a9c0c00000000000000000000000000000000000000000000000000000000000733d4004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000060000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000067846fdd73a5c0000000000000000000000000000000000000000000000000000000063160c14",
    expected: {
      target: SOCKET_REGISTRY_ADDRESS,
      receiverAddress: "0xb814E113A905ae84777bf3f80e4D07a9635b78dD",
      toChainId: 42161,
      amount: "52300000000000000",
      bridgeRequest: {
        id: 11,
        optionalNativeAmount: 0,
        inputToken: "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2",
      },
      middlewareRequest: {
        id: 7,
        optionalNativeAmount: 0,
        inputToken: "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE",
      },
    },
  },
];

const BASE_INVALID_TEST = {
  target: SOCKET_REGISTRY_ADDRESS,
  data: "0xa44bbb150000000000000000000000000000000000000000000000000000000000000020000000000000000000000000b814e113a905ae84777bf3f80e4d07a9635b78dd000000000000000000000000000000000000000000000000000000000000a4b100000000000000000000000000000000000000000000000000b9ce92a9c0c00000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000003a87c025200000000000000000000000000f2f400c138f9fb900576263af0bc7fcde2b1b8a800000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000f2f400c138f9fb900576263af0bc7fcde2b1b8a8000000000000000000000000c30141b657f4216252dc59af2e7cdb9d8792e1b000000000000000000000000000000000000000000000000000b9ce92a9c0c00000000000000000000000000000000000000000000000000000b8e0bd7324e800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000e0800000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000b9ce92a9c0c00000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000004d0e30db000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb0000000000000000000000001111111254fb6c44bac0bed2854e76f90643097d00000000000000000000000000000000000000000000000000b9ce92a9c0c00000000000000000000000000000000000000000000000000000000000733d4004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000060000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000067846fdd73a5c0000000000000000000000000000000000000000000000000000000063160c14",
  expected: {
    target: SOCKET_REGISTRY_ADDRESS,
    receiverAddress: "0xb814E113A905ae84777bf3f80e4D07a9635b78dD",
    toChainId: 42161,
    amount: "52300000000000000",
    bridgeRequest: {
      id: 11,
      optionalNativeAmount: 0,
      inputToken: "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2",
    },
    middlewareRequest: {
      id: 7,
      optionalNativeAmount: 0,
      inputToken: "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE",
    },
  },
};

const invalidTestPermutations = [
  {
    description: "invalid target",
    difference: { target: NOT_SOCKET_REGISTRY },
    error: "INVALID_TARGET",
  },
  {
    description: "invalid address",
    difference: { receiverAddress: "0xb7d8c49945144ec82605ed877a5e0dc4bfbb7f63" },
    error: "INVALID_RECEIVER_ADDRESS",
  },
  { description: "invalid toChainId", difference: { toChainId: 13 }, error: "INVALID_TO_CHAIN_ID" },
  { description: "invalid amount", difference: { amount: "10000000" }, error: "INVALID_AMOUNT" },
  { description: "invalid bridge request id", difference: { bridgeRequest: { id: 20 } }, error: "INVALID_BRIDGE_ID" },
  {
    description: "invalid bridge input token",
    difference: { bridgeRequest: { inputToken: "0xb814E113A905ae84777bf3f80e4D07a9635b78dD" } },
    error: "INVALID_BRIDGE_TOKEN",
  },
  {
    description: "invalid middleware request id",
    difference: { middlewareRequest: { id: 20 } },
    error: "INVALID_MIDDLEWARE_ID",
  },
  {
    description: "invalid middleware token",
    difference: { middlewareRequest: { inputToken: "0xb814E113A905ae84777bf3f80e4D07a9635b78dD" } },
    error: "INVALID_MIDDLEWARE_TOKEN",
  },
];

const invalidCallDataTests: InvalidTestData[] = invalidTestPermutations.map(perm => ({
  description: perm.description,
  target: BASE_INVALID_TEST.target,
  data: BASE_INVALID_TEST.data,
  expected: merge(cloneDeep(BASE_INVALID_TEST.expected), perm.difference),
  error: perm.error,
}));

export { validCallDataTests, invalidCallDataTests };
